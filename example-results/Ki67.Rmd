---
title: "Ki67 Example"
author: "Yi"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
rm(list = ls())
```


```{r, include=FALSE}
files.sources <- list.files(path = "../R/")
x <- sapply(paste0("../R/", files.sources), source)
library(mixmeta)
library(readxl)
library(knitr)
library(kableExtra)
library(latex2exp)
library(numDeriv)

saveplot <- TRUE

```


```{r, include=FALSE}
##
## LOAD DATA
##

## MEDIAN FU 
med.data <- read_excel("Ki67.xlsx", sheet = "MCT")
med.data$mty <- med.data$mct_mo/12

## OBTAIN ETA
eta <- cens.eta(data = med.data, med.year = mty,  n1 = n1, n0 = n0, s1_med = s1_mct, s0_med = s0_mct)$par


## OS DATA

os.data  <- read_excel("Ki67.xlsx", sheet = "OS")
os.data$ty <- os.data$t/12

## HR DATA

dataHR <-read_excel("Ki67.xlsx", sheet = "HR")
dataHR$u_lnHR <- log(dataHR$HR)
ln_ci.low   <- log(dataHR$ci.low)
ln_ci.up    <- log(dataHR$ci.up)
se          <- (ln_ci.up - ln_ci.low)/(2 * qnorm(0.975))
dataHR$v_lnHR <- se^2

## MERGED DATA (OS+HR)
os_hr <- merge(os.data, dataHR, all.x = TRUE)

## THE NUMBER OF UNIQUE DATA
# length(unique(os_hr$study))
```


```{r, include=FALSE}
## 5-YEAR DATA

data.05 <- convert.dt(
  data = os_hr, tK = 5, study = study, ty = ty, 
  n1 = n1, n0 = n0, s1 = s1, s0 = s0, u_lnHR = u_lnHR, v_lnHR = v_lnHR, 
  eta = eta)

## REMOVE OBSERVATIONS WITH MISSING VALUES
data.5 <- data.05[complete.cases(data.05),]

## 3-YEAR DATA

data.03 <- convert.dt(
  data = os_hr, tK = 3, study = study, ty = ty, 
  n1 = n1, n0 = n0, s1 = s1, s0 = s0, u_lnHR = u_lnHR, v_lnHR = v_lnHR, 
  eta = eta)

## REMOVE OBSERVATIONS WITH MISSING VALUES
data.3 <- data.03[complete.cases(data.03),]


head(data.5)
head(data.3)
# write.csv(data.3, "data-3y.csv")
# write.csv(data.5, "data-5y.csv")

```

# $t=3$

```{r, include=FALSE}
## DATA

data <- data.3
# data <- data.5


{
  y1  <- data$u_sen
  y2  <- data$u_spe 
  y3  <- data$u_lnHR
  
  v1  <- data$v_sen
  v2  <- data$v_spe 
  v3  <- data$v_lnHR
  
  v12 <- data$v_senspe 
  v13 <- data$v_senlnHR 
  v23 <- data$v_spelnHR
}

# plogis(y1)
# plogis(-y2)
```

## BNM Model of Hattori and Zhou

```{r}

# bnm.int    <- c(mean(y1), mean(y2), mean(v1), mean(v2), mean(v12))
bnm.int <- rep(0.1, 5)
fn.bnm.ml  <- function(par) llk.BNM.ml(par, y1, y2, v1, v2, v12)
opt.bnm.ml <- nlminb(bnm.int, fn.bnm.ml)

par.bnm.ml <- opt.bnm.ml$par
hes.bnm    <- numDeriv::hessian(fn.bnm.ml, opt.bnm.ml$par)
rownames(hes.bnm) <- colnames(hes.bnm) <- c("mu.se", "mu.sp", "tau.sp", "tau.sp", "rho")
sauc.bnm   <- SAUC.ci(par.bnm.ml, var.matrix = solve(hes.bnm), sauc.type = "sroc" )

# sauc.bnm 

```


## Sensitivity analysis

```{r, fig.height=5, fig.width=5}

PAR.3 <- sapply(seq(0.9, 0.1, -0.1), function(p){
  
  progmeta.sa(
  y1, y2, y3, v1, v2, v3, v12, v13, v23, 
    p = p, 
    sauc.type = "sroc",
    a.interval= c(-10, 10))
  
})


colnames(PAR.3) <- paste0("p=", seq(0.9, 0.1, -0.1))
round(PAR.3, 3) %>%
  kbl(caption ="Parameters from TNM") %>%
  kable_classic_2(full_width = F)

```

### SAUC (CI) at $t=3$

```{r, fig.height=5, fig.width=5}



sauc.mat.3 <- cbind(c(sauc.bnm, conv = opt.bnm.ml$convergence), PAR.3[c(12:14, 17),])
colnames(sauc.mat.3) <- paste0("p=", seq(1, 0.1, -0.1))

round(sauc.mat.3,3) %>%
  kbl(caption ="SAUC") %>%
  kable_classic_2(full_width = F)



```

### Given $p=0.6\approx 23/38$ at $t=3$

```{r, fig.height=5, fig.width=5}

par.mvm.3 <- cbind(par.bnm.ml, PAR.3[c(1,2,4,5,7), c(4,6,8)])
ab.3 <- PAR.3[c(10,11),c(4,6,8)] 

```

# $t=5$

```{r, include=FALSE}
## DATA

data <- data.5


{
  y1  <- data$u_sen
  y2  <- data$u_spe 
  y3  <- data$u_lnHR
  
  v1  <- data$v_sen
  v2  <- data$v_spe 
  v3  <- data$v_lnHR
  
  v12 <- data$v_senspe 
  v13 <- data$v_senlnHR 
  v23 <- data$v_spelnHR
}


```

## BNM Model of Hattori and Zhou

```{r}

# bnm.int    <- c(mean(y1), mean(y2), mean(v1), mean(v2), mean(v12))
bnm.int <- rep(0.1,5)
fn.bnm.ml  <- function(par) llk.BNM.ml(par, y1, y2, v1, v2, v12)
opt.bnm.ml <- nlminb(bnm.int, fn.bnm.ml)

par.bnm.ml <- opt.bnm.ml$par
hes.bnm    <- numDeriv::hessian(fn.bnm.ml, opt.bnm.ml$par)
rownames(hes.bnm) <- colnames(hes.bnm) <- c("mu.se", "mu.sp", "tau.sp", "tau.sp", "rho")
sauc.bnm   <- SAUC.ci(par.bnm.ml, var.matrix = solve(hes.bnm), sauc.type = "sroc" )

# sauc.bnm 

```


## Sensitivity analysis

```{r, fig.height=5, fig.width=5}


PAR.5 <- sapply(seq(0.9, 0.1, -0.1), function(p){
  
  progmeta.sa(
  y1, y2, y3, v1, v2, v3, v12, v13, v23, 
    p = p,
    sauc.type = "sroc",
    a.interval= c(-10, 10))
  
})


colnames(PAR.5) <- paste0("p=", seq(0.9, 0.1, -0.1))
round(PAR.5, 3) %>%
  kbl(caption ="Parameters from TNM") %>%
  kable_classic_2(full_width = F)

```

### SAUC (CI) at $t=5$

```{r, fig.height=5, fig.width=5}



sauc.mat.5 <- cbind(c(sauc.bnm, conv = opt.bnm.ml$convergence), PAR.3[c(12:14, 17),])
colnames(sauc.mat.5) <- paste0("p=", seq(1, 0.1, -0.1))

round(sauc.mat.5,3) %>%
  kbl(caption ="SAUC") %>%
  kable_classic_2(full_width = F)



```

### Given $p=0.6\approx 23/38$ at $t=3$

```{r, fig.height=5, fig.width=5}

par.mvm.5 <- cbind(par.bnm.ml, PAR.5[c(1,2,4,5,7), c(4,6,8)])
ab.5 <- PAR.5[c(10,11),c(4,6,8)] 

```


# PLOT

## SAUC

```{r, fig.height=8, fig.width=12}
if (saveplot) {setEPS(width = 12, height = 8); postscript("ki67.eps")}
title.cex <- 1.2

par(mfcol= c(2,3))

## SROC
SROC(par = par.mvm.3, sroc.type = "sroc", spoint.cex = 1.5)
points(plogis(-data.3$u_spe), plogis(data.3$u_sen))
legend("bottomright", 
       bty='n',
       legend = c(sprintf("p = %.2f, SAUC = %.3f", c(1, 0.6, 0.4, 0.2), c(sauc.mat.3[1,c(1,5,7,9)]))), 
       col = gray.colors(ncol(par.mvm.3), gamma = 1, start = 0, end = 0.8), 
       pch = 18, pt.cex = 1.5, cex = 1.5, 
       lty = rep(1,2))
title("t = 3 (year)")
title("(A)", adj = 0, font.main = 1, cex.main = title.cex)


SROC(par = par.mvm.5, sroc.type = "sroc", spoint.cex = 1.5)
points(plogis(-data.5$u_spe), plogis(data.5$u_sen))
legend("bottomright", 
       bty='n',
       legend = c(sprintf("p = %.2f, SAUC = %.3f", c(1, 0.6, 0.4, 0.2), c(sauc.mat.5[1,c(1,5,7,9)]))), 
       col = gray.colors(ncol(par.mvm.5), gamma = 1, start = 0, end = 0.8), 
       pch = 18, pt.cex = 1.5, cex = 1.5, 
       lty = rep(1,2))
title("t = 5 (year)")
title("(D)", adj = 0, font.main = 1, cex.main = title.cex)


## SAUC
matplot(y = t(sauc.mat.3[1:3,]), ylim = c(0.5,0.8), type = "b", 
        pch = 20, col = c(1,2,2), lty = c(1, 2,2), xlab = "p", ylab = "SAUC",  xaxt = "n")
axis(1, at = 1:10, labels = seq(1,0.1,-0.1))
title("t = 3 (year)")
legend("bottomleft", 
       bty='n',
       legend = c("SAUC", "95% CI"), 
       col = c("black", "red"),
       lty = c(1,2),
							cex = 1.5)
title("(B)", adj = 0, font.main = 1, cex.main = title.cex)

matplot(y = t(sauc.mat.5[1:3,]), ylim = c(0.5,0.8), type = "b", 
        pch = 20, col = c(1,2,2), lty = c(1, 2,2), xlab = "p", ylab = "SAUC",  xaxt = "n")
axis(1, at = 1:10, labels = seq(1,0.1,-0.1))
title("t = 5 (year)")
legend("bottomleft", 
       bty='n',
       legend = c("SAUC", "95% CI"), 
       col = c("black", "red"), 
       lty = c(1,2),
							cex = 1.5)
title("(E)", adj = 0, font.main = 1, cex.main = title.cex)



## A
beta1  <- ab.3[1,1]
alpha1 <- ab.3[2,1]
beta2  <- ab.3[1,2]
alpha2 <- ab.3[2,2]
beta3  <- ab.3[1,3]
alpha3 <- ab.3[2,3]
x <- data.3$u_lnHR/sqrt(data.3$v_lnHR)
curve(pnorm(beta1*x + alpha1), -10, 15, ylim = c(0,1), xlim = c(-3,7),
      xlab = "", ylab = "",
      col=1,
      yaxt='n')
curve(pnorm(beta2*x + alpha2), -5, 10, add = TRUE, col=2) 
curve(pnorm(beta3*x + alpha3), -5, 10, add = TRUE, col=3)
axis(2, at=c(0,0.5,1), labels = c(0,0.5,1))
points(x, rep(0,   length(x)), pch="|", col=1, cex = 1)
title("t = 3 (year)")
legend("topleft", 
       bty='n',
       legend = TeX(sprintf("$p = %.1f$", c(0.6,0.4,0.2))), 
       col = 1:3, cex = 1.2, 
       lty = rep(1,3))
title("(C)", adj = 0, font.main = 1, cex.main = title.cex)
mtext(TeX("$p = \\Phi(\\beta \\, t + \\alpha)$"), side=2, line=2, at=c(0.5), cex = 1)
title(xlab = "t", line=2, cex = 0.7)


## B
beta1  <- ab.5[1,1]
alpha1 <- ab.5[2,1]
beta2  <- ab.5[1,2]
alpha2 <- ab.5[2,2]
beta3  <- ab.5[1,3]
alpha3 <- ab.5[2,3]
x <- data.5$u_lnHR/sqrt(data.5$v_lnHR)
curve(pnorm(beta1*x + alpha1), -5, 10, ylim = c(0,1), xlim = c(-3,7),
      xlab = "", ylab="",
      col=1,
      yaxt='n')
curve(pnorm(beta2*x + alpha2), -5, 10, add = TRUE, col=2) 
curve(pnorm(beta3*x + alpha3), -5, 10, add = TRUE, col=3)
axis(2, at=c(0,0.5,1), labels = c(0,0.5,1))
points(x, rep(0,   length(x)), pch="|", col=1, cex = 1)
title("t = 5 (year)")
legend("topleft", 
       bty='n',
       legend = TeX(sprintf("$p = %.1f$", c(0.6,0.4,0.2))), 
       col = 1:3, cex = 1.2, 
       lty = rep(1,3))
title("(F)", adj = 0, font.main = 1, cex.main = title.cex)
mtext(TeX("$p = \\Phi(\\beta \\, t + \\alpha)$"), side=2, line=2, at=c(0.5), cex = 1)
title(xlab = "t", line=2, cex = 0.7)


par(mfrow = c(1,1))

if(saveplot) dev.off()
```

