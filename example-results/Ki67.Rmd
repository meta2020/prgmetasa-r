---
title: "Ki67 Example"
author: "Yi"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
rm(list = ls())
files.sources <- list.files(path = "../R/")
x <- sapply(paste0("../R/", files.sources), source)
library(mixmeta)
library(readxl)
library(knitr)
library(kableExtra)

saveplot <- FALSE

```

```{r, include=FALSE}
##
## LOAD DATA
##

## MEDIAN FU 
med.data <- read_excel("Ki67.xlsx", sheet = "MCT")
med.data$mty <- med.data$mct_mo/12

## OBTAIN ETA
eta <- cens.eta(data = med.data, med.year = mty,  n1 = n1, n0 = n0, s1_med = s1_mct, s0_med = s0_mct)$par


## OS DATA

os.data  <- read_excel("Ki67.xlsx", sheet = "OS")
os.data$ty <- os.data$t/12

## HR DATA

dataHR <-read_excel("Ki67.xlsx", sheet = "HR")
dataHR$u_lnHR <- log(dataHR$HR)
ln_ci.low   <- log(dataHR$ci.low)
ln_ci.up    <- log(dataHR$ci.up)
se          <- (ln_ci.up - ln_ci.low)/(2 * qnorm(0.975))
dataHR$v_lnHR <- se^2

## MERGED DATA (OS+HR)
os_hr <- merge(os.data, dataHR, all.x = TRUE)

## THE NUMBER OF UNIQUE DATA
# length(unique(os_hr$study))
```

```{r, include=FALSE}
## 5-YEAR DATA

data.05 <- convert.dt(
  data = os_hr, tK = 5, study = study, ty = ty, 
  n1 = n1, n0 = n0, s1 = s1, s0 = s0, u_lnHR = u_lnHR, v_lnHR = v_lnHR, 
  eta = eta)

## REMOVE OBSERVATIONS WITH MISSING VALUES
data.5 <- data.05[complete.cases(data.05),]

## 3-YEAR DATA

data.03 <- convert.dt(
  data = os_hr, tK = 3, study = study, ty = ty, 
  n1 = n1, n0 = n0, s1 = s1, s0 = s0, u_lnHR = u_lnHR, v_lnHR = v_lnHR, 
  eta = eta)

## REMOVE OBSERVATIONS WITH MISSING VALUES
data.3 <- data.03[complete.cases(data.03),]


head(data.5)
head(data.3)
# write.csv(data.3, "data-3y.csv")
# write.csv(data.5, "data-5y.csv")

```

# $t=3$

```{r, include=FALSE}
## DATA

data <- data.3
# data <- data.5


{
  y1  <- data$u_sen
  y2  <- data$u_spe 
  y3  <- data$u_lnHR
  
  v1  <- data$v_sen
  v2  <- data$v_spe 
  v3  <- data$v_lnHR
  
  v12 <- data$v_senspe 
  v13 <- data$v_senlnHR 
  v23 <- data$v_spelnHR
}

# plogis(y1)
# plogis(-y2)
```

## BNM Model of Hattori and Zhou

```{r}

bnm.int    <- c(mean(y1), mean(y2), mean(v1), mean(v2), mean(v12))
fn.bnm.ml  <- function(par) .llk.BNM.ml(par, y1, y2, v1, v2, v12)
opt.bnm.ml <- nlminb(bnm.int, fn.bnm.ml,
              lower = c(rep(-Inf,2), rep(0,2),  -1),
              upper = c(rep( Inf,2), rep(Inf,2), 1)
              )
par.bnm.ml <- opt.bnm.ml$par
hes.bnm    <- numDeriv::hessian(fn.bnm.ml, opt.bnm.ml$par)
rownames(hes.bnm) <- colnames(hes.bnm) <- c("mu.se", "mu.sp", "tau.sp", "tau.sp", "rho")

sauc.bnm <- SAUC.ci(par.bnm.ml, var.matrix = solve(hes.bnm), sauc.type = "sroc" )

# sauc.bnm 

```


## Sensitivity analysis

```{r, fig.height=5, fig.width=5}

## INITIAL VALUE

init3 <- c(median(y1), median(y2), median(y3), 
           median(v1), median(v2), median(v3), median(v12), median(v13), median(v23))

PAR.O <- sapply(seq(1, 0.1, -0.1), function(p){
  
  fn.o <- function(par) .clk.TNM.ml(par, y1, y2, y3, v1, v2, v3, v12, v13, v23,
                            p = p, 
                            a.interval= c(-10, 10)
                            )

opt.o <- nlminb(c(init3, 1), fn.o,
              lower = c(rep(-Inf,3), rep(0,3),   rep(-1,3), 0),
              upper = c(rep( Inf,3), rep(Inf,3), rep( 1,3), 2)
              )


par <- c(opt.o$convergence, opt.o$par, plogis(opt.o$par[1:2]))
names(par) <- c("conv", 
                "mu.se", "mu.sp", "mu.lnhr", "tau.se", "tau.sp", "tau.lnhr", 
                "rho1", "rho2", "rho3",
                "beta",
                "sen", "spe")
par
})


colnames(PAR.O) <- paste0("p=", seq(1, 0.1, -0.1))
round(PAR.O, 3) %>%
  kbl(caption ="Parameters from TNM") %>%
  kable_classic_2(full_width = F)

```

### SAUC (CI) at $t=3$

```{r, fig.height=5, fig.width=5}

sauc.sa <- sapply(seq(1, 0.1, -0.1), function(p){
  
  fn.o <- function(par) .clk.TNM.ml(par, y1, y2, y3, v1, v2, v3, v12, v13, v23,
                            p = p, 
                            a.interval= c(-10, 10)
                            )

  opt.o <- nlminb(c(init3, 1), fn.o)

num.hessian <- numDeriv::hessian(fn.o, opt.o$par)
rownames(num.hessian) <- colnames(num.hessian) <- c("u1", "u2", "u3", "t1", "t2", "t3", "r1", "r2", "r3", "b")

if (p==1) inv.I.fun.m <- solve(num.hessian[-10,-10]) else inv.I.fun.m <- solve(num.hessian)

var.matrix <-  inv.I.fun.m[c(1,2,4,5,7), c(1,2,4,5,7)]

sauc.ci <- SAUC.ci(opt.o$par[c(1,2,4,5,7)],
                   var.matrix = var.matrix, sauc.type = "sroc")

c(sauc = sauc.ci, conv = opt.o$convergence)

})

sauc.mat.3 <- cbind(c(sauc.bnm, conv = opt.bnm.ml$convergence), sauc.sa[,-1])
colnames(sauc.mat.3) <- paste0("p=", seq(1, 0.1, -0.1))

round(sauc.mat.3,3) %>%
  kbl(caption ="SAUC") %>%
  kable_classic_2(full_width = F)


# data.3 <- data.frame(p=seq(1, 0.1, -0.1), sauc=sauc.mat.3[1,])
# write.csv(data.3, "sauc.3y.csv")

# matplot(y = t(sauc.mat.3[1:3,]), ylim = c(0.5,0.8), type = "b", 
#         pch = 20, col = c(1,2,2), lty = c(1, 2,2), xlab = "p", ylab = "SAUC",  xaxt = "n")
# axis(1, at = 1:10, labels = seq(1,0.1,-0.1))
# title(main = paste0(3, " year"))

# write.csv(sauc.mat.3, "sacu.3y.csv")
```

### Given $p=0.6\approx 23/38$ at $t=3$

```{r, fig.height=5, fig.width=5}


fn.o <- function(par) .clk.TNM.ml(par, y1, y2, y3, v1, v2, v3, v12, v13, v23,
                         p = round(23/38,2), 
                         a.interval= c(-10, 10)
                         )


opt.o <- nlminb(c(init3,1), fn.o)

num.hessian <- numDeriv::hessian(fn.o, opt.o$par)
rownames(num.hessian) <- colnames(num.hessian) <- c("u1", "u2", "u3", "t1", "t2", "t3", "r1", "r2", "r3", "b")
var.ml <- solve(num.hessian)
var.matrix <-  var.ml[c(1,2,4,5,7), c(1,2,4,5,7)]

sauc.ci <- SAUC.ci(opt.o$par[c(1,2,4,5,7)], var.matrix = var.matrix, sauc.type = "sroc")

par <- c(opt.o$par,  sauc.ci, plogis(opt.o$par[1:2]), opt.o$convergence)
names(par) <- c( "u1", "u2", "u3", "t1", "t2", "t3", "r1", "r2", "r3",
             "b",
             "sauc", "sauc.lb", "sauc.ub",
             "sen", "spe", "conv")
par.mvm.3 <- cbind(par.bnm.ml, par[c(1,2,4,5,7)])


```

# $t=5$

```{r, include=FALSE}
## DATA

data <- data.5
# data <- data.5


{
  y1  <- data$u_sen
  y2  <- data$u_spe 
  y3  <- data$u_lnHR
  
  v1  <- data$v_sen
  v2  <- data$v_spe 
  v3  <- data$v_lnHR
  
  v12 <- data$v_senspe 
  v13 <- data$v_senlnHR 
  v23 <- data$v_spelnHR
}


```

## BNM Model of Hattori and Zhou

```{r}

bnm.int    <- c(mean(y1), mean(y2), mean(v1), mean(v2), mean(v12))
fn.bnm.ml  <- function(par) .llk.BNM.ml(par, y1, y2, v1, v2, v12)
opt.bnm.ml <- nlminb(bnm.int, fn.bnm.ml,
              lower = c(rep(-Inf,2), rep(0,2),  -1),
              upper = c(rep( Inf,2), rep(Inf,2), 1)
              )
par.bnm.ml <- opt.bnm.ml$par
hes.bnm    <- numDeriv::hessian(fn.bnm.ml, opt.bnm.ml$par)
rownames(hes.bnm) <- colnames(hes.bnm) <- c("mu.se", "mu.sp", "tau.sp", "tau.sp", "rho")

sauc.bnm <- SAUC.ci(par.bnm.ml, var.matrix = solve(hes.bnm), sauc.type = "sroc" )

# sauc.bnm
```

## Sensitivity analysis

```{r, fig.height=5, fig.width=5}

## INITIAL VALUE

init3 <- c(mean(y1), mean(y2), mean(y3), mean(v1), mean(v2), mean(v3), mean(v12), mean(v13), mean(v23))


PAR.O <- sapply(seq(1, 0.1, -0.1), function(p){
  
  fn.o <- function(par) .clk.TNM.ml(par, y1, y2, y3, v1, v2, v3, v12, v13, v23,
                            p = p, 
                            a.interval= c(-10, 10)
                            )

opt.o <- nlminb(c(init3, 1), fn.o)

par <- c(opt.o$convergence, opt.o$par, plogis(opt.o$par[1:2]))
names(par) <- c("conv", 
                "mu.se", "mu.sp", "mu.lnhr", "tau.se", "tau.sp", "tau.lnhr", "rho1", "rho2", "rho3",
                "beta",
                "sen", "spe")
par
})


colnames(PAR.O) <- seq(1, 0.1, -0.1)
colnames(PAR.O) <- paste("p=",seq(1, 0.1, -0.1))

round(PAR.O, 3)%>%
  kbl(caption ="SAUC") %>%
  kable_classic_2(full_width = F)

```

### SAUC (CI) at $t=5$

```{r, fig.height=5, fig.width=5}
sauc.sa <- sapply(seq(1, 0.1, -0.1), function(p){
  
  fn.o <- function(par) .clk.TNM.ml(par, y1, y2, y3, v1, v2, v3, v12, v13, v23,
                            p = p, 
                            a.interval= c(-10, 10)
                            )

  opt.o <- nlminb(c(init3, 1), fn.o)

num.hessian <- numDeriv::hessian(fn.o, opt.o$par)
rownames(num.hessian) <- colnames(num.hessian) <- c("u1", "u2", "u3", "t1", "t2", "t3", "r1", "r2", "r3", "b")

if (p==1) inv.I.fun.m <- solve(num.hessian[-10,-10]) else inv.I.fun.m <- solve(num.hessian)

var.matrix <-  inv.I.fun.m[c(1,2,4,5,7), c(1,2,4,5,7)]

sauc.ci <- SAUC.ci(opt.o$par[c(1,2,4,5,7)],
                   var.matrix = var.matrix, sauc.type = "sroc")

c(sauc = sauc.ci, conv = opt.o$convergence)

})

sauc.mat.5 <- cbind(c(sauc.bnm, conv = opt.bnm.ml$convergence), sauc.sa[,-1])
colnames(sauc.mat.5) <- paste("p=",seq(1, 0.1, -0.1))

round(sauc.mat.5,3)%>%
  kbl(caption ="SAUC") %>%
  kable_classic_2(full_width = F)
# sauc.mat.5 <- cbind(c(sauc.bnm, conv = fn.tnmml$convergence), sauc.sa[,-1])
# sauc.mat.5

# data.5 <- data.frame(p=seq(1, 0.1, -0.1), sauc=sauc.mat.5[1,])
# write.csv(data.5, "sauc.5y.csv")

```

### Given $p=0.6\approx 23/38$ at $t=5$

```{r, fig.height=5, fig.width=5}

fn.o <- function(par) .clk.TNM.ml(par, y1, y2, y3, v1, v2, v3, v12, v13, v23,
                         p = round(23/38,2), 
                         a.interval= c(-10, 10)
                         )


opt.o <- nlminb(c(init3,1), fn.o)

num.hessian <- numDeriv::hessian(fn.o, opt.o$par)
rownames(num.hessian) <- colnames(num.hessian) <- c("u1", "u2", "u3", "t1", "t2", "t3", "r1", "r2", "r3", "b")
var.ml <- solve(num.hessian)
var.matrix <-  var.ml[c(1,2,4,5,7), c(1,2,4,5,7)]

sauc.ci <- SAUC.ci(opt.o$par[c(1,2,4,5,7)], var.matrix = var.matrix, sauc.type = "sroc")

par <- c(opt.o$par,  sauc.ci, plogis(opt.o$par[1:2]), opt.o$convergence)
names(par) <- c( "u1", "u2", "u3", "t1", "t2", "t3", "r1", "r2", "r3",
             "b",
             "sauc", "sauc.lb", "sauc.ub",
             "sen", "spe", "conv")
# par
par.mvm.5 <- cbind(par.bnm.ml, par[c(1,2,4,5,7)])
# par.mvm.5


```

# PLOT

```{r, fig.height=9, fig.width=9}

if (saveplot) {setEPS(width = 9, height = 9); postscript("ki67.eps")}

par(mfrow = c(2,2))

matplot(y = t(sauc.mat.3[1:3,]), ylim = c(0.5,0.8), type = "b", 
        pch = 20, col = c(1,2,2), lty = c(1, 2,2), xlab = "p", ylab = "SAUC",  xaxt = "n")
axis(1, at = 1:10, labels = seq(1,0.1,-0.1))
title(main = paste0(3, " year"))
legend("bottomright", 
       bty='n',
       legend = c("SAUC", "95% CI"), 
       col = c("black", "red"),
       lty = c(1,2))

matplot(y = t(sauc.mat.5[1:3,]), ylim = c(0.5,0.8), type = "b", 
        pch = 20, col = c(1,2,2), lty = c(1, 2,2), xlab = "p", ylab = "SAUC",  xaxt = "n")
axis(1, at = 1:10, labels = seq(1,0.1,-0.1))
title(main = paste0(5, " year"))
legend("bottomright", 
       bty='n',
       legend = c("SAUC", "95% CI"), 
       col = c("black", "red"), 
       lty = c(1,2))


SROC(par = par.mvm.3, sroc.type = "sroc")
points(plogis(-data.3$u_spe), plogis(data.3$u_sen))
legend("bottomright", 
       bty='n',
       legend = c(sprintf("p = %.2f, SAUC = %.3f", round(c(1, 23/38),2), c(sauc.mat.3[1,c(1,5)]))), 
       col = c("black", "grey"), pch = 18, pt.cex = 2, cex = 1, 
       lty = rep(1,2))
title("3 year")

SROC(par = par.mvm.5, sroc.type = "sroc")
points(plogis(-data.5$u_spe), plogis(data.5$u_sen))
legend("bottomright", 
       bty='n',
       legend = c(sprintf("p = %.2f, SAUC = %.3f", round(c(1, 23/38),2), c(sauc.mat.5[1,c(1,5)]))), 
       col = c("black", "grey"), pch = 18, pt.cex = 2, cex = 1, 
       lty = rep(1,2))
title("5 year")

par(mfrow = c(1,1))

if(saveplot) dev.off()
```
