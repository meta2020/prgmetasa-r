---
title: 'Simulation Result 1: C~Exp(0.2)'
author: "Yi"
date: "`r Sys.Date()`"
output:
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
options(knitr.kable.NA = '')
library(knitr)
library(kableExtra)
library(tidyverse)

# library(ggpubr)
rm(list = ls())
save.tex <- T
```



```{r, include=FALSE}

## FUNCTION FOR CREATING OBJECT

dimname.sauc <- list(c("M1BNM.P", "M2BNM.O", "M3TNM.P", "M4TNM.O","M5TNM.Prop"), "SAUC")
dimname.cr   <- list(c("M1BNM.P", "M2BNM.O", "M3TNM.P", "M4TNM.O","M5TNM.Prop"), "CR")

# dimname.par <- list(c("u1", "u2", "u3", "t1", "t2", "t3", "r1", "r2", "r3", "b"), c("BNM.Pop", "BNM.Pub", "TNM.Prop"))
# dimname.sauc.med <- list(c("BNM.Pop", "BNM.Pub", "TNM.Prop"), c("Median (Q1, Q3)"))

result_list <- function(path = "exp0.2/N20/ptdis2_HR1_p0.8.RData", 
                        dnm.cr = dimname.cr, dnm.sauc = dimname.sauc,
                        only.conv=TRUE){ 

  load(path)
	  if(only.conv){
    
    nconv <- DATA[16,]!=0
    DATA[1:15, nconv] <- NA
    
  }
  
  # ## convergence rate
  cr.id <- as.numeric(DATA[16,]==0)  ## converge is TRUE
  cr    <- matrix(cr.id, ncol = 5, byrow = TRUE)
  cr.sum  <- matrix(sapply(1:5, function(i) round(mean(cr[,i], na.rm = TRUE)*100,2)),5,1, dimnames = dnm.cr) ## converge rate in successful results
  
  # MED of sauc
  sauc.val <- matrix(DATA[15,], ncol = 5, byrow = TRUE)
  succ <- nrow(sauc.val)/10
  
  med <- apply(sauc.val, 2, function(x) median(x, na.rm = TRUE))*100
  # med <- med-med[1]
  q1  <- apply(sauc.val, 2, function(x) quantile(x, probs = 0.25, na.rm = TRUE))*100
  q3  <- apply(sauc.val, 2, function(x) quantile(x, probs = 0.75, na.rm = TRUE))*100
  
  sauc.med.q13 <- matrix(sprintf("%.2f (%.2f, %.2f)", med, q1, q3), 5,1, dimnames = dnm.sauc)

  
  return(list(sauc.med.q13 = sauc.med.q13, cr = cr.sum))
}
```


```{r, include=FALSE}

## CREATE OBJECT
## OBJECT NAME EXAMPLE: N20.D1.HR1.P0.8

for(folder in c("exp0.2/", "U14/")){
	
	for(N in c("N20", "N30", "N50", "N100")){
	
	for(ptdist in 1:2){
		
		for(HR in 1:2){
			
			for(p in seq(0.7, 0.3, -0.2)) {
				
				if (folder=="exp0.2/") fd <- "F1." else fd <- "F2."
				assign(paste0(fd, N, ".D", ptdist, ".HR", HR, ".P", p), 
											result_list(paste0(folder, N, "/ptdis", ptdist, "_HR", HR, "_p", p, ".RData")) )
			}
		}
	}
}
	
}

```



```{r}

## FUNCTION FOR CREATING SMALL TABLES

tsauc.tab <- function(FD, N, ptdist, HR, p1=0.7, p2=0.5, p3=0.3){
	
sauc <- data.frame(
	NN = c(N, rep(NA, 5)),
  Methods = c("HZ$_P$", "HZ$_O$","Prop", "Prop.O", "Prop.p", "CR"),
  P1 = c(get(paste0("F", FD, ".N", N, ".D", ptdist, ".HR", HR, ".P", p1) )$sauc.med.q13, 
         get(paste0("F", FD, ".N", N, ".D", ptdist, ".HR", HR, ".P", p1) )$cr[3]),
	
	P2 = c(get(paste0("F", FD, ".N", N, ".D", ptdist, ".HR", HR, ".P", p2) )$sauc.med.q13, 
         get(paste0("F", FD, ".N", N, ".D", ptdist, ".HR", HR, ".P", p2) )$cr[3]),
	
	P3 = c(get(paste0("F", FD, ".N", N, ".D", ptdist, ".HR", HR, ".P", p3) )$sauc.med.q13, 
         get(paste0("F", FD, ".N", N, ".D", ptdist, ".HR", HR, ".P", p3) )$cr[3])
	)[c(1,2,3,6),]
colnames(sauc) <- c("N", "Method", rep("Median (Q1, Q3)",3))

return(sauc)
}

## tsauc.tab(20,1,HR)


SAUC.tab.format <- function(
		FD=1,
		HR=1, 
		cap = "Summary of the tSAUC for Biomarker1",
		# format = ifelse(save.tex, "latex", "html"),
		tb.lab
		){
	
	## PTS ~ U(50,150)
DT.PT1 <- rbind(tsauc.tab(FD, 20,1,HR), tsauc.tab(FD, 30,1,HR), tsauc.tab(FD, 50,1,HR), tsauc.tab(FD, 100,1,HR))
## PTS ~ U(50,300)
DT.PT2 <- rbind(tsauc.tab(FD, 20,2,HR), tsauc.tab(FD, 30,2,HR), tsauc.tab(FD, 50,2,HR), tsauc.tab(FD, 100,1,HR))

DT.MK1 <- cbind.data.frame(
	Patients = c("50-150", rep(NA, nrow(DT.PT1)-1), "50-300", rep(NA, nrow(DT.PT1)-1)), 
	rbind(DT.PT1, DT.PT2))
rownames(DT.MK1) <- NULL


output <- DT.MK1 %>%
  kbl(
    caption=cap,
    # format =fmt,
    # format = ifelse(save.tex, "latex", "html"),
    format = "latex",
    longtable = F, 
    booktabs = T,
    align = "r",
    position = "!htb",
    linesep = c(rep('',3), '\\addlinespace'),
    escape = FALSE,
    label = tb.lab,) %>%
  add_header_above(c(rep("",3), "$p = 0.7$"=1, "$p = 0.5$"=1, "$p = 0.3$"=1),escape = FALSE) %>%
  footnote(general = "
			Median with 25th and 75th empirical quartiles (Q1, Q3) of the SAUC at $t=2$ are reported. 
			$N$ denotes the number of the published studies. 
			Prop denotes the proposed sensitivity analysis method;
			HZ$_P$ denotes the HZ model using the population (published and unpublished) studies; 
			HZ$_O$ denotes the HZ model using the published (observed) studies.
			CR denotes the proportion of convergenced estimates among 1000 repetition.
			All the entries are multiplied by 100.", 
   escape = FALSE, 
			threeparttable = TRUE,  
			general_title = "")

return(output)

}
```



```{r mk1}
# Biomarker1; EXP(0.2)

if (save.tex) sink("TB-SAUC-HR1-EXP-CR.tex")

SAUC.tab.format(
	FD=1,
	HR=1, 
	cap="Summary of the estimated SAUC(2) in Biomarker1 when the true censored time is distributed as $Exp(0.2)$.", 
	tb.lab = "sauc1")

if (save.tex) sink()

```



```{r mk2}
# Biomarker2; EXP(0.2)

if (save.tex) sink("TB-SAUC-HR2-EXP-CR.tex")

SAUC.tab.format(
	FD=1,
	HR=2, 
	cap="Summary of the estimated SAUC(2) in Biomarker2 when the true censored time is distributed as $Exp(0.2)$.", 	
	tb.lab = "sauc2")

if (save.tex) sink()

```





```{r mk21}
# Biomarker1; U(1,4)

if (save.tex) sink("TB-SAUC-HR1-UNIF-CR.tex")

SAUC.tab.format(
	FD=2,
	HR=1, 
	cap="Summary of the estimated SAUC(2) in Biomarker1 when the true censored time is distributed as $U(1,4)$, but a misspecified exponential distribution is fitted.", 	
	tb.lab = "sauc3")

if (save.tex) sink()

```


```{r mk22}
# Biomarker2; U(1,4)

if (save.tex) sink("TB-SAUC-HR2-UNIF-CR.tex")

SAUC.tab.format(
	FD=2,
	HR=2, 
	cap="Summary of the estimated SAUC(2) in Biomarker2 when the true censorcensored time is distributed as $U(1,4)$, but a misspecified exponential distribution is fitted.", 	
	tb.lab = "sauc4")

if (save.tex) sink()

```





